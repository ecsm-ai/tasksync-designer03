<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TaskSync Designer ‚Äì Gantt Refresh</title>
    <meta name="color-scheme" content="light dark" />
    <style>
      :root{--bg:#f7f9fc;--fg:#0f172a;--card:#fff;--muted:#64748b;--rail:#eef2f7;--railBorder:#e6ebf2;--bar:#4f46e5;--bar2:#4338ca;--border:#e6ebf2}
      .dark{--bg:#0b0f14;--fg:#e5e7eb;--card:#0f172a;--muted:#9aa7b8;--rail:#1f2937;--railBorder:#2a3443;--border:#223041}
      html,body{height:100%}
      body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
      .container{max-width:1120px;margin:0 auto;padding:16px}
      h1{margin:0 0 12px;font-size:18px}
      .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px}
      .btn{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--fg);cursor:pointer}
      .btn.primary{background:var(--bar);border-color:var(--bar);color:#fff}
      .btn:hover{opacity:.95}
      .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:10px}
      /* header days */
      .days{display:grid;gap:6px;grid-auto-flow:column;grid-auto-columns:minmax(36px,1fr);align-items:end}
      .day{font-size:12px;text-align:center;color:var(--muted)}
      .dow{display:block;font-size:11px;margin-top:2px}
      /* task list */
      .list{display:flex;flex-direction:column;gap:14px;margin-top:10px}
      .task{border:1px solid var(--border);border-radius:14px;padding:10px}
      .taskhead{display:flex;justify-content:space-between;align-items:center;font-size:14px}
      .tasktitle{font-weight:700}
      .taskmeta{color:var(--muted)}
      .rail{position:relative;display:grid;grid-auto-flow:column;grid-auto-columns:minmax(36px,1fr);gap:6px;margin-top:8px}
      .cell{height:24px;background:var(--rail);border:1px solid var(--railBorder);border-radius:8px}
      .bar{position:absolute;height:24px;border-radius:8px;background:var(--bar);box-shadow:0 2px 4px rgba(0,0,0,.15);display:flex;align-items:center;justify-content:center;color:#fff;font-size:11px;white-space:nowrap;transition:transform .15s ease}
      .bar:hover{transform:translateY(-1px)}
      .muted{color:var(--muted)}
      .controls{margin-left:auto;display:flex;gap:6px}
      .split{display:grid;grid-template-columns:1fr 320px;gap:16px}
      @media(max-width:960px){.split{grid-template-columns:1fr}}
      .detail{position:sticky;top:12px}
      .field{margin-top:10px;font-size:14px}
      .lbl{display:block;color:var(--muted);margin-bottom:4px}
      input[type="range"]{width:100%}
      select,input,textarea{font:inherit;color:inherit;background:transparent;border:1px solid var(--border);border-radius:10px;padding:8px}
      textarea{min-height:80px}
      .kicker{display:flex;gap:8px;align-items:center}
    </style>
  </head>
  <body>
    <div class="container">
      <div class="toolbar">
        <h1>TaskSync Designer</h1>
        <button id="prev" class="btn" title="Ââç„ÅÆÊúà">‚óÄÔ∏é Êúà</button>
        <button id="next" class="btn" title="Ê¨°„ÅÆÊúà">Êúà ‚ñ∂Ô∏é</button>
        <div class="controls">
          <button id="theme" class="btn" title="„ÉÜ„Éº„ÉûÂàáÊõø">üåô/‚òÄÔ∏è</button>
        </div>
      </div>

      <!-- calendar header -->
      <div class="card">
        <div id="days" class="days"></div>
      </div>

      <div class="split">
        <!-- left: tasks -->
        <div>
          <div id="list" class="list"></div>
        </div>
        <!-- right: detail -->
        <div>
          <div class="card detail" id="detailCard">
            <div class="muted">„Çø„Çπ„ÇØË©≥Á¥∞</div>
            <div class="field"><strong id="dTitle">Â∑¶„ÅÆ„Éê„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</strong></div>
            <div class="field"><span class="lbl">„ÇØ„É©„Ç§„Ç¢„É≥„Éà / Ê°à‰ª∂</span><div id="dMeta" class="muted">‚Äî</div></div>
            <div class="field"><span class="lbl">ÊúüÈñì</span><div id="dRange" class="muted">‚Äî</div></div>
            <div class="field">
              <span class="lbl">ÈÄ≤Êçó</span>
              <div class="kicker"><input id="dProg" type="range" min="0" max="100" value="0"><span id="dProgVal" style="width:42px" class="muted">0%</span></div>
            </div>
            <div class="field">
              <span class="lbl">„É°„É¢</span>
              <textarea id="dNotes" placeholder="‰æùÈ†º‰∫ãÈ†Ö„Éª‰øÆÊ≠£ÁÇπ„Å™„Å©"></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ===== Utilities =====
      const fmt = d => d.toISOString().slice(0,10);
      const parse = s => new Date(s+"T00:00:00");
      const addDays = (d,n)=> new Date(d.getFullYear(), d.getMonth(), d.getDate()+n);
      const daysInMonth = d => new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();

      // ===== State =====
      const storeKey = 'tsd_gantt_refresh_v1';
      let state = {
        monthAnchor: new Date(), // ÁèæÂú®„ÅÆÊúà„ÇíÂü∫Ê∫ñ
        tasks: []
      };

      const seed = (()=>{
        const a = new Date();
        return [
          {id:'t4', title:'LP„Éá„Ç∂„Ç§„É≥Âà∂‰Ωú', client:'Beta Studio', project:'ABC', start:fmt(new Date(a.getFullYear(), a.getMonth(), 10)), end:fmt(new Date(a.getFullYear(), a.getMonth(), 16)), progress:41, notes:''},
          {id:'t1', title:'LP„Éá„Ç∂„Ç§„É≥ÔºàÊßãÊàêÊ°àÔºâ', client:'Acme Co.', project:'EC„Çµ„Ç§„ÉàÂà∑Êñ∞', start:fmt(new Date(a.getFullYear(), a.getMonth(), 4)), end:fmt(new Date(a.getFullYear(), a.getMonth(), 9)), progress:60, notes:''},
          {id:'t2', title:'„Éê„Éä„Éº3Á®Æ', client:'Beta Studio', project:'„Ç≠„É£„É≥„Éö„Éº„É≥A/W', start:fmt(new Date(a.getFullYear(), a.getMonth(), 5)), end:fmt(new Date(a.getFullYear(), a.getMonth(), 15)), progress:46, notes:''},
          {id:'t3', title:'„É≠„Ç¥ÂæÆË™øÊï¥', client:'Acme Co.', project:'„Éñ„É©„É≥„Éâ„Ç¨„Ç§„Éâ', start:fmt(new Date(a.getFullYear(), a.getMonth(), 14)), end:fmt(new Date(a.getFullYear(), a.getMonth(), 19)), progress:0, notes:''}
        ];
      })();

      function load(){
        try{ const saved = JSON.parse(localStorage.getItem(storeKey)||'{}'); if(saved && saved.tasks) state = saved; else state.tasks = seed; }
        catch{ state.tasks = seed; }
      }
      function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); }

      // ===== Render Days Header =====
      function renderDays(){
        const root = document.getElementById('days');
        root.innerHTML='';
        const y = state.monthAnchor.getFullYear();
        const m = state.monthAnchor.getMonth();
        const n = daysInMonth(state.monthAnchor);
        for(let i=1;i<=n;i++){
          const d = new Date(y,m,i);
          const div = document.createElement('div'); div.className='day';
          div.textContent = `${m+1}/${i}`;
          const dow = document.createElement('span'); dow.className='dow'; dow.textContent = 'Êó•ÊúàÁÅ´Ê∞¥Êú®ÈáëÂúü'[d.getDay()];
          div.appendChild(dow);
          root.appendChild(div);
        }
      }

      // ===== Render Task List =====
      let selectedId = null;
      function clampToMonth(start, end){
        const y = state.monthAnchor.getFullYear();
        const m = state.monthAnchor.getMonth();
        const first = new Date(y,m,1);
        const last = new Date(y,m,daysInMonth(state.monthAnchor));
        const s = start < first ? first : start;
        const e = end > last ? last : end;
        // convert to 0-based index and span
        const index = Math.max(0, Math.floor((s - first)/86400000));
        const span = Math.max(1, Math.floor((e - first)/86400000) - index + 1);
        return { index, span, total: daysInMonth(state.monthAnchor) };
      }

      function renderList(){
        const y = state.monthAnchor.getFullYear();
        const m = state.monthAnchor.getMonth();
        const total = daysInMonth(state.monthAnchor);
        const list = document.getElementById('list');
        list.innerHTML='';
        state.tasks.forEach(t=>{
          const task = document.createElement('div'); task.className='task';
          const head = document.createElement('div'); head.className='taskhead';
          const tl = document.createElement('div'); tl.className='tasktitle'; tl.textContent = t.title; head.appendChild(tl);
          const tr = document.createElement('div'); tr.className='taskmeta'; tr.textContent = `${t.client} „Éª ${t.project}`; head.appendChild(tr);
          task.appendChild(head);

          const rail = document.createElement('div'); rail.className='rail';
          rail.style.gridTemplateColumns = `repeat(${total}, minmax(36px,1fr))`;
          for(let i=0;i<total;i++){ const c=document.createElement('div'); c.className='cell'; rail.appendChild(c); }

          const {index, span} = clampToMonth(parse(t.start), parse(t.end));
          const bar = document.createElement('div'); bar.className='bar'; bar.textContent = `${t.progress}%`;
          bar.style.left = `calc(${index}*(100%/${total}) + ${index*6}px)`;
          bar.style.width = `calc(${span}*(100%/${total}) + ${(span-1)*6}px)`;
          bar.onclick = ()=>{ selectedId=t.id; renderDetail(); };

          rail.appendChild(bar);
          task.appendChild(rail);
          list.appendChild(task);
        });
      }

      // ===== Detail Panel =====
      function renderDetail(){
        const t = state.tasks.find(x=>x.id===selectedId);
        const title = document.getElementById('dTitle');
        const meta = document.getElementById('dMeta');
        const range = document.getElementById('dRange');
        const prog = document.getElementById('dProg');
        const progVal = document.getElementById('dProgVal');
        const notes = document.getElementById('dNotes');
        if(!t){ title.textContent='Â∑¶„ÅÆ„Éê„Éº„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ'; meta.textContent='‚Äî'; range.textContent='‚Äî'; prog.value=0; progVal.textContent='0%'; notes.value=''; return; }
        title.textContent = t.title;
        meta.textContent = `${t.client} „Éª ${t.project}`;
        range.textContent = `${t.start} ‚Üí ${t.end}`;
        prog.value = t.progress; progVal.textContent = t.progress + '%';
        notes.value = t.notes || '';
        prog.oninput = (e)=>{ t.progress = Number(e.target.value); progVal.textContent=t.progress+'%'; save(); renderList(); };
        notes.onchange = ()=>{ t.notes = notes.value; save(); };
      }

      // ===== Theme & Month nav =====
      function bindUI(){
        document.getElementById('theme').onclick = ()=>{
          const dark = document.documentElement.classList.toggle('dark');
          localStorage.setItem('tsd_theme', dark? 'dark':'light');
        };
        const savedTheme = localStorage.getItem('tsd_theme');
        if(savedTheme==='dark') document.documentElement.classList.add('dark');

        document.getElementById('prev').onclick = ()=>{ state.monthAnchor = new Date(state.monthAnchor.getFullYear(), state.monthAnchor.getMonth()-1, 1); save(); renderDays(); renderList(); };
        document.getElementById('next').onclick = ()=>{ state.monthAnchor = new Date(state.monthAnchor.getFullYear(), state.monthAnchor.getMonth()+1, 1); save(); renderDays(); renderList(); };
      }

      // ===== Init =====
      load();
      bindUI();
      renderDays();
      renderList();
      renderDetail();
    </script>
  </body>
</html>
